<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>PBC SyncFlow</title> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/pilipmul/PBC-cek-Piutang/main/logo%20citanusa.png">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Montserrat:wght@700&display=swap" rel="stylesheet">
    
    <style>
        /* --- BASE STYLE --- */
        * {
            box-sizing: border-box;
            font-family: 'Inter', "Segoe UI", Roboto, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0; padding: 0;
            background: url('https://raw.githubusercontent.com/pilipmul/PBC-cek-Piutang/6d34302da336e6b94b116bff0ce07084c5f95c3e/BG2.jpg') no-repeat center center fixed;
            background-size: cover;
            display: flex; justify-content: center; align-items: flex-start;
            min-height: 100vh; padding: 20px 10px;
        }

        .container {
            width: 100%; max-width: 480px;
            background: #ffffff; padding: 20px 22px 28px 22px;
            border-radius: 16px; border: 2px solid #1877f2;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            position: relative; text-align: center;
        }

        /* --- HEADER ACTIONS --- */
        .header-actions {
            position: absolute; top: 10px; left: 20px;
            display: flex; align-items: center; gap: 8px; z-index: 10;
        }

        #refreshBtn, #historyBtn {
            background: none; border: none; cursor: pointer;
            padding: 5px; transition: transform 0.2s;
        }

        #refreshBtn:active, #historyBtn:active { transform: scale(0.9); opacity: 0.6; }

        #titleBtn {
            width: 100%; max-width: 280px; cursor: pointer;
            user-select: none; transition: opacity 0.2s, transform 0.2s;
        }
        #titleBtn:active { opacity: 0.7; transform: scale(0.98); }

        /* --- FORM INPUTS --- */
        #nameWrapper {
            position: relative; padding: 10px 0;
            border-top: 1px solid #1877f2; border-bottom: 1px solid #1877f2;
        }

        input, textarea {
            width: 100%; padding: 10px; border: none; font-size: 1rem;
            background-color: transparent; text-align: center; color: #333;
        }
        input:focus, textarea:focus { outline: none; }
        input.qty { border-left: 1px solid #1877f2; border-right: 1px solid #1877f2; }

        textarea {
            resize: none; height: 40px !important;
            overflow-y: hidden; padding-top: 10px;
        }

        /* --- GRID SYSTEM --- */
        .row-3col {
            display: grid; grid-template-columns: 40% 20% 36%;
            gap: 8px; align-items: start; margin-bottom: 10px;
            border-bottom: 1px solid #1877f2; padding: 10px 0;
            position: relative;
        }

        /* --- BUTTONS --- */
        .btn-group { display: flex; gap: 10px; margin-top: 15px; align-items: center; }
        button.in, button.out {
            flex: 1; padding: 10px; border-radius: 8px; font-weight: 700;
            color: white; border: none; background-color: #595959; cursor: pointer;
        }

        .add-row { background: transparent; border: none; cursor: pointer; transition: transform 0.2s; }
        .add-row:hover { transform: scale(1.1); }
        .delete-row {
            position: absolute; top: 0; right: 0; background: none; border: none;
            color: #dc2626; font-size: 18px; font-weight: bold; cursor: pointer;
        }

        /* --- AUTOCOMPLETE --- */
        .autocomplete-list {
            position: absolute; background: #fff; border: 1px solid #ccc;
            border-radius: 8px; z-index: 100; max-height: 200px;
            overflow-y: auto; width: 100%; box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            text-align: left; display: none;
        }
        .autocomplete-item { padding: 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0; }
        .autocomplete-item:hover { background-color: #1877f2; color: white; }

        /* --- POPUPS & TOAST --- */
        .popup-toast {
            position: fixed; bottom: -60px; left: 50%; transform: translateX(-50%);
            background: #333; color: #fff; padding: 10px 22px; border-radius: 20px;
            transition: bottom 0.4s ease; z-index: 9999;
        }
        .popup-toast.show { bottom: 30px; }

        .popup-full, .desc-popup {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none;
            justify-content: center; align-items: center; z-index: 2000;
        }
        .popup-box { background: #fff; padding: 24px; border-radius: 16px; width: 90%; max-width: 320px; text-align: center; }

        #historyPopup {
            position: absolute; top: 45px; left: 20px; background: white;
            border: 1px solid #ddd; border-radius: 10px; width: 260px;
            max-height: 300px; overflow-y: auto; padding: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2); display: none; text-align: left;
        }
        .loader { display: none; border: 4px solid #f3f3f3; border-top: 4px solid #1877f2; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 15px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>

<body>
<div class="container">
    <div class="header-actions">
        <button id="refreshBtn" type="button" onclick="fetchDataAndUpdateUI(false)">
            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#1877f2"><path d="M480-160q-134 0-227-93t-93-227q0-134 93-227t227-93q69 0 132 28.5T720-690v-110h80v280H520v-80h168q-32-56-87.5-88T480-720q-100 0-170 70t-70 170q0 100 70 170t170 70q77 0 139-44t87-116h84q-28 106-114 173t-196 67Z"/></svg>
        </button>
        <button id="historyBtn" type="button" onclick="toggleHistoryPopup()" style="display:none; color:#1877f2; font-weight: bold;">~5</button>
    </div>
    
    <div id="historyPopup">
        <h4 style="margin:0 0 10px 0; color:#1877f2; text-align:center;">5 Last Trx</h4>
        <div id="historyList"></div>
    </div>
    
    <div style="margin: 20px 0;">
        <img id="titleBtn" src="https://raw.githubusercontent.com/pilipmul/PBC-cek-Piutang/c917d70c8d2a8f1630b8dd1400a2d13c2aa55d65/Title%20PBC%20B.png" alt="PBC SyncFlow">
    </div>
    
    <form id="myForm">
        <div id="nameWrapper">
            <input type="text" id="name" placeholder="Name" autocomplete="off" required>
            <div id="nameList" class="autocomplete-list"></div>
        </div>

        <div id="itemContainer">
            <div class="row-3col item-row">
                <div style="position: relative;">
                    <input type="text" class="item" placeholder="Item" autocomplete="off" required>
                    <div class="autocomplete-list"></div>
                </div>
                <input type="number" class="qty" min="1" placeholder="Qty" required>
                <div style="position: relative;">
                    <textarea class="desc" placeholder="Description"></textarea>
                    <button type="button" class="delete-row">×</button>
                </div>
            </div>
        </div>

        <div class="btn-group">
            <button type="button" class="in" id="btnIn">IN</button>
            <button type="button" class="add-row" id="addRow">
                <svg xmlns="http://www.w3.org/2000/svg" height="32px" viewBox="0 -960 960 960" width="32px" fill="#1877f2"><path d="M440-440H200v-80h240v-240h80v240h240v80H520v240h-80v-240Z"/></svg>
            </button>
            <button type="button" class="out" id="btnOut">OUT</button>
        </div>
        <div id="loader" class="loader"></div>
    </form>
</div>

<div id="popupToast" class="popup-toast"></div>

<div id="successPopup" class="popup-full">
    <div class="popup-box">
        <div id="successMode" style="background:#facc15; font-weight:700; padding:5px; border-radius:10px; margin-bottom:10px;"></div>
        <div id="successItems" style="text-align:left; margin-bottom:15px; font-size: 0.9rem;"></div>
        <button onclick="closeSuccessPopup()" style="width:100%; padding:10px; background:#1877f2; color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">Close</button>
    </div>
</div>

<div id="descPopup" class="desc-popup">
    <div class="popup-box" style="max-width:400px;">
        <h4 style="margin:0 0 10px 0;">Description Detail</h4>
        <textarea id="descPopupInput" style="height:150px !important; border:1px solid #ddd; border-radius:8px; background:#f9f9f9; text-align:left;"></textarea>
        <button onclick="closeDescPopup()" style="width:100%; padding:10px; background:#1877f2; color:white; border:none; border-radius:8px; font-weight:bold; margin-top:10px;">Save & Close</button>
    </div>
</div>

<div id="passPopup" class="popup-full">
    <div class="popup-box">
        <h3>Admin Password</h3>
        <input type="password" id="adminPass" style="border:1px solid #ddd; border-radius:8px; margin-bottom:15px; background:#f5f5f5;">
        <div class="btn-group">
            <button onclick="checkPassword()" style="background:#1877f2; color:white; padding:10px; border:none; border-radius:8px; flex:1; font-weight:bold;">OK</button>
            <button onclick="closePassPopup()" style="background:#595959; color:white; padding:10px; border:none; border-radius:8px; flex:1; font-weight:bold;">Batal</button>
        </div>
    </div>
</div>

<script>
/* --- CONFIGURATION --- */
// GANTI DENGAN URL WEB APP GOOGLE SCRIPT ANDA
const scriptURL = 'https://script.google.com/macros/s/AKfycbwgPshFWH1uquWsPdR2Gp-V29e5FwiL5ZIJBj2eixI4vOaWrWRIC_9xZ-wRObcgmn-39g/exec';

let nameData = [], itemData = [], itemStock = {}, lastTransactions = [];
let gaMode = false;
let activeTextarea = null;
let longPressTimer;

/* --- DATA SYNC --- */
async function fetchDataAndUpdateUI(isInitialLoad = true) {
    const refreshBtn = document.getElementById("refreshBtn");
    refreshBtn.style.opacity = "0.5";
    try {
        const resp = await fetch(`${scriptURL}?action=getDropdownData`);
        const data = await resp.json();
        nameData = data.names;
        itemData = data.items;
        itemStock = data.stocks;
        lastTransactions = data.transactions || [];
        if (isInitialLoad) initAutocomplete();
    } catch (e) { showToast("❌ Gagal Sinkronisasi Data!"); }
    finally { refreshBtn.style.opacity = "1"; }
}

/* --- AUTOCOMPLETE --- */
function initAutocomplete() {
    setupAutocomplete(document.getElementById("name"), document.getElementById("nameList"), nameData);
    document.querySelectorAll(".item").forEach(input => {
        setupAutocomplete(input, input.parentNode.querySelector(".autocomplete-list"), itemData, true);
    });
}

function setupAutocomplete(input, box, data, isItem=false) {
    input.addEventListener("input", () => {
        const val = input.value.trim().toLowerCase();
        if (!val) { box.style.display = "none"; return; }
        const match = data.filter(d => {
            if (!d.toLowerCase().includes(val)) return false;
            if (isItem && !gaMode && (itemStock[d] || 0) <= 0) return false;
            return true;
        }).slice(0, 10);
        
        if (!match.length) { box.style.display = "none"; return; }
        box.innerHTML = match.map(m => `<div class="autocomplete-item">${m}</div>`).join('');
        box.style.display = "block";
        
        box.querySelectorAll(".autocomplete-item").forEach(div => {
            div.onclick = () => {
                input.value = div.textContent;
                box.style.display = "none";
            };
        });
    });
}

/* --- FORM SUBMISSION --- */
async function handleSubmit(mode) {
    const name = document.getElementById("name").value.trim();
    if (!nameData.includes(name)) return showToast("⚠️ Pilih Nama yang valid!");

    const rows = [...document.querySelectorAll(".item-row")];
    const items = rows.map(row => ({
        item: row.querySelector(".item").value.trim(),
        qty: parseInt(row.querySelector(".qty").value),
        desc: row.querySelector(".desc").value.trim()
    })).filter(it => it.item && it.qty);

    if (!items.length) return showToast("⚠️ Isi data barang & qty!");

    if (mode === "out") {
        for (let it of items) {
            if ((itemStock[it.item] || 0) < it.qty) return showToast(`⚠️ Stok ${it.item} tidak cukup!`);
        }
    }

    document.getElementById("loader").style.display = "block";
    try {
        const body = new URLSearchParams();
        body.append('name', name);
        body.append('mode', mode);
        body.append('date', new Date().toLocaleDateString('id-ID', {day:'2-digit', month:'short', year:'2-digit'}).replace(/\./g,''));
        body.append('items', JSON.stringify(items));

        const resp = await fetch(scriptURL, { method: 'POST', body: body });
        const res = await resp.json();
        
        if (res.result === "success") {
            showSuccessPopup(mode, items);
            document.getElementById("myForm").reset();
            fetchDataAndUpdateUI(false);
        } else { showToast("❌ Error: " + res.error); }
    } catch (e) { showToast("❌ Koneksi Gagal!"); }
    finally { document.getElementById("loader").style.display = "none"; }
}

/* --- FEATURES --- */
function startPress(e) {
    if (e.target.classList.contains("desc")) {
        activeTextarea = e.target;
        longPressTimer = setTimeout(() => {
            document.getElementById("descPopupInput").value = activeTextarea.value;
            document.getElementById("descPopup").style.display = "flex";
        }, 600);
    }
}
function cancelPress() { clearTimeout(longPressTimer); }
document.addEventListener("mousedown", startPress); document.addEventListener("touchstart", startPress);
document.addEventListener("mouseup", cancelPress); document.addEventListener("touchend", cancelPress);

function closeDescPopup() {
    if (activeTextarea) activeTextarea.value = document.getElementById("descPopupInput").value;
    document.getElementById("descPopup").style.display = "none";
}

function showToast(m) {
    const t = document.getElementById("popupToast");
    t.textContent = m; t.classList.add("show");
    setTimeout(() => t.classList.remove("show"), 3000);
}

function showSuccessPopup(m, its) {
    document.getElementById("successMode").textContent = m.toUpperCase();
    document.getElementById("successItems").innerHTML = its.map(i => `• ${i.item} (${i.qty})`).join('<br>');
    document.getElementById("successPopup").style.display = "flex";
}
function closeSuccessPopup() { document.getElementById("successPopup").style.display = "none"; }

function toggleHistoryPopup() {
    const p = document.getElementById("historyPopup");
    p.style.display = p.style.display === "block" ? "none" : "block";
    if (p.style.display === "block") {
        document.getElementById("historyList").innerHTML = lastTransactions.map(t => `
            <div style="font-size:0.8rem; border-bottom:1px solid #eee; padding:5px 0;">
                <b>${t[0]}</b>: <span style="color:${t[1]==='in'?'#10b981':'#ef4444'}">${t[1].toUpperCase()}</span> ${t[2]}
            </div>`).join('');
    }
}

function checkPassword() {
    if (document.getElementById("adminPass").value === "admin123") {
        document.getElementById("passPopup").style.display = "none";
        document.getElementById("adminPass").value = "";
        handleSubmit("in");
    } else showToast("❌ Password Salah!");
}
function closePassPopup() { document.getElementById("passPopup").style.display = "none"; }

/* --- CONTROLS --- */
document.getElementById("addRow").onclick = () => {
    const container = document.getElementById("itemContainer");
    if (container.children.length >= 5) return showToast("⚠️ Maksimal 5 baris");
    const clone = container.children[0].cloneNode(true);
    clone.querySelectorAll("input, textarea").forEach(i => i.value = "");
    container.appendChild(clone);
    initAutocomplete();
};
document.addEventListener("click", e => {
    if (e.target.classList.contains("delete-row")) {
        if (document.querySelectorAll(".item-row").length > 1) e.target.closest(".item-row").remove();
        else showToast("⚠️ Minimal 1 baris");
    }
});
document.getElementById("titleBtn").onclick = () => {
    gaMode = !gaMode;
    showToast(gaMode ? "GA Mode ON" : "GA Mode OFF");
    document.getElementById("historyBtn").style.display = gaMode ? "block" : "none";
};
document.getElementById("btnIn").onclick = () => document.getElementById("passPopup").style.display = "flex";
document.getElementById("btnOut").onclick = () => handleSubmit("out");

window.onload = () => fetchDataAndUpdateUI(true);
</script>
</body>
</html>

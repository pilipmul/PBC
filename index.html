<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PBC GOODS ORDER</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
body { font-family: 'Inter', sans-serif; background: #fff; margin: 0; display: flex; justify-content: center; }
.container { width: 100%; max-width: 480px; padding: 26px 20px; }
h2 { text-align: center; color: #1877f2; margin-bottom: 20px; }
input, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; }
button { border: none; border-radius: 8px; cursor: pointer; font-weight: 700; }
.row-3col { display: grid; grid-template-columns: 2fr 0.7fr 1.5fr; gap: 8px; margin-bottom: 10px; }
button.in { background: #16a34a; color: white; padding: 12px; }
button.out { background: #dc2626; color: white; padding: 12px; }
button.add-row { background: #facc15; padding: 10px; width: 100%; margin-top: 8px; }
#msg { text-align: center; font-weight: 600; margin-top: 12px; }
</style>
</head>

<body>
<div class="container">
  <h2>PBC GOODS ORDER</h2>

  <input id="name" placeholder="Ketik nama..." list="nameList">
  <datalist id="nameList"></datalist>

  <div id="itemContainer">
    <div class="row-3col item-row">
      <input class="item" placeholder="Item..." list="itemList">
      <input class="qty" type="number" min="1" placeholder="Qty">
      <textarea class="desc" placeholder="Keterangan..."></textarea>
    </div>
  </div>
  <datalist id="itemList"></datalist>

  <button class="add-row" id="addRow">+ Tambah Baris</button>

  <div style="display:flex; gap:8px; margin-top:12px;">
    <button class="in" onclick="submitForm('in')">IN</button>
    <button class="out" onclick="submitForm('out')">OUT</button>
  </div>

  <p id="msg"></p>
</div>

<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbwwchLjFj59UteUuMH_PVsZjcYvOupD0a4aZUQaQ-VkPu6i-DNou_K5bFgMlFYggwLR/exec";
let names = [], items = [], stocks = {};

// === Ambil data dropdown ===
fetch(scriptURL + "?action=getDropdownData")
  .then(res => res.json())
  .then(data => {
    names = data.names || [];
    items = data.items || [];
    document.getElementById("nameList").innerHTML = names.map(n => `<option value="${n}">`).join("");
    document.getElementById("itemList").innerHTML = items.map(i => `<option value="${i}">`).join("");
  })
  .catch(err => console.error("Gagal ambil data:", err));

// === Tambah baris baru ===
document.getElementById("addRow").addEventListener("click", () => {
  const container = document.getElementById("itemContainer");
  const clone = container.firstElementChild.cloneNode(true);
  clone.querySelectorAll("input, textarea").forEach(i => i.value = "");
  // pasangkan kembali datalist
  clone.querySelector(".item").setAttribute("list", "itemList");
  container.appendChild(clone);
});

// === Ambil stok otomatis saat pilih item ===
document.addEventListener("input", e => {
  if (e.target.classList.contains("item")) {
    const itemName = e.target.value.trim();
    if (itemName) {
      fetch(`${scriptURL}?action=getStockForItem&item=${encodeURIComponent(itemName)}`)
        .then(r => r.json())
        .then(d => {
          stocks[itemName] = d.stock;
          console.log(`Stok ${itemName}: ${d.stock}`);
        })
        .catch(() => console.warn("Gagal ambil stok."));
    }
  }
});

// === Submit data ke Apps Script ===
function submitForm(mode) {
  const name = document.getElementById("name").value.trim();
  if (!name) return showMsg("⚠️ Isi nama terlebih dahulu.");

  const rows = [...document.querySelectorAll(".item-row")].map(r => ({
    item: r.querySelector(".item").value.trim(),
    qty: +r.querySelector(".qty").value,
    desc: r.querySelector(".desc").value.trim()
  })).filter(r => r.item && r.qty > 0);

  if (!rows.length) return showMsg("⚠️ Isi minimal 1 item.");

  // === Validasi stok otomatis ===
  if (mode === "out") {
    for (const row of rows) {
      const available = stocks[row.item] ?? 0;
      if (row.qty > available) {
        return showMsg(`❌ ${row.item} melebihi stok (${available})!`);
      }
    }
  }

  const payload = { name, items: rows, date: new Date().toLocaleDateString("id-ID"), mode };
  showMsg("⏳ Mengirim data...");

  fetch(scriptURL + "?action=submitForm", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  })
    .then(res => res.text())
    .then(msg => showMsg(msg))
    .catch(() => showMsg("❌ Gagal kirim data."));
}

function showMsg(txt) {
  document.getElementById("msg").textContent = txt;
}
</script>
</body>
</html>

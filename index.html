<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>PBC SyncFlow Pro</title> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/pilipmul/PBC-cek-Piutang/main/logo%20citanusa.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1877f2;
            --primary-dark: #145dbf;
            --success: #10b981;
            --danger: #ef4444;
            --gray: #64748b;
            --bg-light: #f8fafc;
        }

        * { box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { 
            margin: 0; padding: 0; 
            background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('https://raw.githubusercontent.com/pilipmul/PBC-cek-Piutang/6d34302da336e6b94b116bff0ce07084c5f95c3e/BG2.jpg') no-repeat center center fixed; 
            background-size: cover; display: flex; justify-content: center; 
            align-items: flex-start; min-height: 100vh; padding: 20px 10px;
        }
        
        .container { 
            width: 100%; max-width: 450px; background: rgba(255, 255, 255, 0.98); 
            padding: 25px; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.3); 
            position: relative; backdrop-filter: blur(10px);
        }
        
        #titleBtn { width: 100%; max-width: 260px; cursor: pointer; transition: 0.3s; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1)); }
        #titleBtn:hover { transform: translateY(-2px); }
        #titleBtn:active { transform: scale(0.95); }

        .input-group { position: relative; margin-bottom: 15px; border: 1.5px solid #e2e8f0; border-radius: 12px; transition: 0.3s; background: #fff; }
        .input-group:focus-within { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(24, 119, 242, 0.1); }
        
        input, textarea { 
            width: 100%; padding: 12px; border: none; font-size: 14px; 
            background: transparent; text-align: center; outline: none; color: #1e293b;
        }
        
        /* Layout Baris Item */
        .item-row { 
            position: relative; background: var(--bg-light); border-radius: 15px;
            padding: 15px; margin-bottom: 15px; border: 1px solid #e2e8f0;
            display: grid; grid-template-columns: 1fr 80px; gap: 10px;
        }
        
        .row-top { grid-column: span 2; display: flex; gap: 10px; }
        .row-bottom { grid-column: span 2; }

        .qty-input { width: 80px; border-left: 1px solid #cbd5e1; }
        
        /* Buttons */
        .btn-group { display: flex; gap: 12px; margin-top: 20px; }
        button { 
            flex: 1; padding: 12px; border: none; border-radius: 12px; 
            font-weight: 700; cursor: pointer; transition: 0.3s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        
        .btn-in { background: var(--gray); color: white; }
        .btn-out { background: var(--primary); color: white; }
        .btn-add { background: #f1f5f9; color: var(--primary); flex: 0.4; }
        button:hover { filter: brightness(1.1); }
        button:active { transform: scale(0.98); }

        /* Autocomplete */
        .autocomplete-list { 
            position: absolute; top: 100%; left: 0; right: 0; background: #fff; 
            border-radius: 12px; z-index: 2000; max-height: 200px; overflow-y: auto; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.15); display: none; margin-top: 5px;
        }
        .autocomplete-item { padding: 12px; cursor: pointer; border-bottom: 1px solid #f1f5f9; text-align: left; font-size: 13px; }
        .autocomplete-item:hover { background: var(--primary); color: white; }
        .stock-tag { float: right; font-size: 10px; background: #e2e8f0; padding: 2px 6px; border-radius: 10px; color: var(--gray); }

        .delete-row { 
            position: absolute; top: -10px; right: -10px; background: white; 
            color: var(--danger); width: 24px; height: 24px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); font-size: 18px; padding: 0;
        }

        /* Popups */
        .popup-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 9000; backdrop-filter: blur(4px); }
        .popup-box { background: #fff; border-radius: 20px; padding: 25px; width: 90%; max-width: 350px; text-align: center; }
        
        .spinning { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        #historyPopup { 
            position: absolute; top: 50px; left: 10px; background: #fff; 
            width: 280px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 15px; display: none; z-index: 5000; border: 1px solid var(--primary);
        }

        .toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: #1e293b; color: white; padding: 12px 25px; border-radius: 30px;
            font-size: 14px; z-index: 10000; display: none; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>

<div id="loaderOverlay" class="popup-overlay"><div style="width: 50px; height: 50px; border: 5px solid #fff; border-top-color: var(--primary); border-radius: 50%;" class="spinning"></div></div>

<div class="container">
    <div class="header-actions" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <button id="refreshBtn" onclick="fetchDataAndUpdateUI(false)" style="background:none; width:32px; height:32px; padding:0;">
            <svg id="refreshIcon" xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24" fill="var(--primary)"><path d="M480-160q-134 0-227-93t-93-227q0-134 93-227t227-93q69 0 132 28.5T720-690v-110h80v280H520v-80h168q-32-56-87.5-88T480-720q-100 0-170 70t-70 170q0 100 70 170t170 70q77 0 139-44t87-116h84q-28 106-114 173t-196 67Z"/></svg>
        </button>
        <button id="historyBtn" onclick="toggleHistoryPopup(event)" style="display:none; background:var(--primary); color:white; width:auto; padding: 4px 12px; font-size: 12px; border-radius: 20px;">ðŸ“œ History</button>
    </div>

    <div id="historyPopup">
        <h4 style="margin:0 0 12px 0; color:var(--primary);">5 Transaksi Terakhir</h4>
        <div id="historyList" style="max-height: 250px; overflow-y: auto;"></div>
    </div>

    <div style="text-align: center; margin-bottom: 25px;">
        <img id="titleBtn" src="https://raw.githubusercontent.com/pilipmul/PBC-cek-Piutang/c917d70c8d2a8f1630b8dd1400a2d13c2aa55d65/Title%20PBC%20B.png" alt="PBC SyncFlow">
    </div>

    <form id="myForm">
        <div class="input-group">
            <input type="text" id="name" placeholder="Pilih Nama Anda" autocomplete="off" required>
            <div id="nameList" class="autocomplete-list"></div>
        </div>

        <div id="itemContainer">
            <div class="item-row">
                <button type="button" class="delete-row" style="display:none">Ã—</button>
                <div class="row-top">
                    <div style="flex:1; position:relative;">
                        <input type="text" class="item" placeholder="Cari Item..." autocomplete="off" required>
                        <div class="autocomplete-list"></div>
                    </div>
                    <input type="number" class="qty qty-input" min="1" placeholder="Qty" required>
                </div>
                <div class="row-bottom">
                    <textarea class="desc" placeholder="Catatan (Opsional)" rows="1" oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'"></textarea>
                </div>
            </div>
        </div>

        <div class="btn-group">
            <button type="button" class="btn-in" id="btnIn">MASUK</button>
            <button type="button" class="btn-add" id="addRow">
                <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24" fill="currentColor"><path d="M440-440H200v-80h240v-240h80v240h240v80H520v240h-80v-240Z"/></svg>
            </button>
            <button type="button" class="btn-out" id="btnOut">KELUAR</button>
        </div>
    </form>
</div>

<div id="passPopup" class="popup-overlay">
    <div class="popup-box">
        <h3 style="margin-top:0">Admin Required</h3>
        <input type="password" id="adminPass" placeholder="Password" style="border:1px solid #ddd; border-radius:8px; margin-bottom:15px; text-align:center;">
        <div style="display:flex; gap:10px">
            <button onclick="checkPassword()" style="background:var(--primary); color:white;">Login</button>
            <button onclick="closePassPopup()" style="background:#eee; color:#333;">Batal</button>
        </div>
    </div>
</div>

<div id="successPopup" class="popup-overlay">
    <div class="popup-box">
        <div id="successIcon" style="font-size: 50px; color: var(--success); margin-bottom:10px;">check_circle</div>
        <h2 id="successTitle" style="margin:0; color: var(--success);">Berhasil!</h2>
        <div id="successItems" style="text-align:left; margin:15px 0; background:#f8fafc; padding:10px; border-radius:10px; font-size:13px;"></div>
        <button onclick="closeSuccessPopup()" style="background:var(--primary); color:white; width:100%;">Selesai</button>
    </div>
</div>

<div id="toast" class="toast"></div>

<script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbzNzaOwIeHkxlp9wdeHDlCLTfqbXlS-A6yzC8c-m4KDIzT-JlBLK_5QqBc6lHXmK41GSQ/exec';
    let nameData = [], itemData = [], itemStock = {}, lastTransactions = [], gaMode = false;

    // Load Data
    async function fetchDataAndUpdateUI(isInitial = true) {
        const icon = document.getElementById("refreshIcon");
        icon.classList.add("spinning");
        try {
            const resp = await fetch(`${scriptURL}?action=getDropdownData`);
            const data = await resp.json();
            nameData = data.names; itemData = data.items; itemStock = data.stocks; 
            lastTransactions = data.transactions || [];
            initAutocomplete();
            if(!isInitial) showToast("âœ… Data diperbarui");
        } catch (e) { 
            showToast("âŒ Koneksi Gagal"); 
        } finally { 
            icon.classList.remove("spinning");
        }
    }

    function initAutocomplete() {
        setupAutocomplete(document.getElementById("name"), document.getElementById("nameList"), nameData);
        document.querySelectorAll(".item").forEach(el => {
            setupAutocomplete(el, el.nextElementSibling, itemData, true);
        });
    }

    function setupAutocomplete(input, box, data, isItem = false) {
        input.onfocus = () => input.dispatchEvent(new Event('input'));
        input.oninput = () => {
            const val = input.value.trim().toLowerCase();
            const matches = data.filter(d => d.toLowerCase().includes(val)).slice(0, 10);
            
            if (matches.length > 0) {
                box.innerHTML = matches.map(m => {
                    const stock = isItem ? `<span class="stock-tag">Stok: ${itemStock[m] || 0}</span>` : '';
                    return `<div class="autocomplete-item">${m}${stock}</div>`;
                }).join('');
                box.style.display = "block";
                
                box.querySelectorAll(".autocomplete-item").forEach(item => {
                    item.onclick = () => {
                        input.value = item.childNodes[0].textContent;
                        box.style.display = "none";
                        // Auto focus ke Qty setelah pilih item
                        if(isItem) input.closest('.row-top').querySelector('.qty').focus();
                    };
                });
            } else {
                box.style.display = "none";
            }
        };
    }

    // Submit Logic
    async function doSubmit(mode) {
        const name = document.getElementById("name").value.trim();
        if (!nameData.includes(name)) return showToast("âš ï¸ Pilih nama valid!");

        const rows = document.querySelectorAll(".item-row");
        const items = [];
        let valid = true;

        rows.forEach(row => {
            const item = row.querySelector(".item").value.trim();
            const qty = parseInt(row.querySelector(".qty").value);
            const desc = row.querySelector(".desc").value.trim();

            if (item && qty > 0) {
                if (mode === "out" && (itemStock[item] || 0) < qty) {
                    showToast(`âš ï¸ Stok ${item} tidak cukup!`);
                    valid = false;
                }
                items.push({ item, qty, desc });
            }
        });

        if (!valid || items.length === 0) return;

        document.getElementById("loaderOverlay").style.display = "flex";
        const body = new URLSearchParams({
            name, mode, 
            items: JSON.stringify(items),
            date: new Date().toISOString()
        });

        try {
            const res = await fetch(scriptURL, { method: 'POST', body });
            const data = await res.json();
            if (data.result === "success") {
                showSuccess(mode, items);
                document.getElementById("myForm").reset();
                document.querySelectorAll(".item-row:not(:first-child)").forEach(r => r.remove());
                fetchDataAndUpdateUI(false);
            }
        } catch (e) {
            showToast("âŒ Gagal mengirim data");
        } finally {
            document.getElementById("loaderOverlay").style.display = "none";
        }
    }

    // UI Helpers
    function showToast(m) {
        const t = document.getElementById("toast");
        t.textContent = m;
        t.style.display = "block";
        setTimeout(() => t.style.display = "none", 3000);
    }

    function showSuccess(mode, items) {
        const list = items.map(i => `<div>â€¢ ${i.item} <b style="float:right">${i.qty}</b></div>`).join('');
        document.getElementById("successItems").innerHTML = list;
        document.getElementById("successTitle").textContent = mode === 'in' ? 'Barang Masuk!' : 'Barang Keluar!';
        document.getElementById("successPopup").style.display = "flex";
    }

    function toggleHistoryPopup(e) {
        e.stopPropagation();
        const p = document.getElementById("historyPopup");
        const isVisible = p.style.display === "block";
        if (!isVisible) {
            p.style.display = "block";
            document.getElementById("historyList").innerHTML = lastTransactions.map(t => `
                <div style="padding:10px; border-bottom:1px solid #f1f5f9; font-size:12px;">
                    <div style="display:flex; justify-content:space-between">
                        <b>${t[0]}</b>
                        <span style="color:${t[1]=='in'?'var(--success)':'var(--danger)'}">${t[1].toUpperCase()}</span>
                    </div>
                    <div style="color:var(--gray)">${t[2]}</div>
                </div>
            `).join('');
        } else {
            p.style.display = "none";
        }
    }

    // Global Events
    document.getElementById("addRow").onclick = () => {
        const container = document.getElementById("itemContainer");
        if (container.children.length >= 5) return showToast("Maksimal 5 baris");
        const clone = container.children[0].cloneNode(true);
        clone.querySelectorAll("input, textarea").forEach(i => i.value = "");
        clone.querySelector(".delete-row").style.display = "flex";
        container.appendChild(clone);
        initAutocomplete();
    };

    document.addEventListener("click", e => {
        if (e.target.classList.contains("delete-row")) e.target.closest(".item-row").remove();
        if (!e.target.closest(".autocomplete-list")) document.querySelectorAll(".autocomplete-list").forEach(l => l.style.display = "none");
        if (!e.target.closest("#historyPopup") && !e.target.closest("#historyBtn")) document.getElementById("historyPopup").style.display = "none";
    });

    document.getElementById("titleBtn").onclick = () => {
        gaMode = !gaMode;
        document.getElementById("historyBtn").style.display = gaMode ? "block" : "none";
        showToast(gaMode ? "Admin Mode Aktif" : "User Mode Aktif");
    };

    document.getElementById("btnIn").onclick = () => document.getElementById("passPopup").style.display = "flex";
    document.getElementById("btnOut").onclick = () => doSubmit("out");
    
    function checkPassword() {
        if (document.getElementById("adminPass").value === "admin123") {
            closePassPopup();
            doSubmit("in");
        } else showToast("âŒ Password Salah");
    }

    function closePassPopup() { document.getElementById("passPopup").style.display = "none"; document.getElementById("adminPass").value = ""; }
    function closeSuccessPopup() { document.getElementById("successPopup").style.display = "none"; }

    window.onload = () => fetchDataAndUpdateUI(true);
</script>

</body>
</html>
